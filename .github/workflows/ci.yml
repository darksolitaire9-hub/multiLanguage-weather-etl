name: Multi-Language CI

on:
  push:
    branches: [main, feature/**]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # PYTHON
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv & Python dependencies
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.cargo/bin:$PATH"
          uv pip install --system .
          pip install pylint

      - name: Run Python linting
        run: python -m pylint src tests || echo "pylint failed"

      # R
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.3'
          use-public-rspm: true

      - name: Install R system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential r-base-dev libcurl4-openssl-dev libssl-dev libxml2-dev libavfilter-dev libavformat-dev libavcodec-dev libavdevice-dev libavutil-dev libswscale-dev ffmpeg cmake gdal-bin libgdal-dev libudunits2-dev

      - name: Restore R dependencies
        run: |
          Rscript -e "install.packages('renv')"
          Rscript -e "options(repos = c(CRAN = 'https://packagemanager.posit.co/cran/__linux__/jammy/latest')); renv::restore()"

      - name: Check R environment
        run: Rscript -e "print('R environment OK')"

      # JULIA
      - name: Set up Julia
        uses: julia-actions/setup-julia@v1
        with:
          version: '1.9'

      - name: Install Julia dependencies
        run: julia --project=. -e 'using Pkg; Pkg.instantiate()'

      - name: Check Julia status
        run: julia --project=. -e 'using Pkg; Pkg.status()'
