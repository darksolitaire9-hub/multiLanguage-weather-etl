name: Multi-Language Weather ETL CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04  # Match your devcontainer
    
    steps:
      - uses: actions/checkout@v3
      
      # OS Detection (for debugging)
      - name: Verify OS
        run: |
          cat /etc/os-release
          echo "Running on: $(uname -s)"
      
      # Python Setup with uv
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          
      # R Setup (Ubuntu specific)
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          
      - name: Install R system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            r-cran-readr \
            r-cran-dplyr
            
      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ env.R_LIBS_USER }}
          key: r-packages-${{ hashFiles('**/DESCRIPTION') }}
          
      # Julia Setup
      - name: Setup Julia
        uses: julia-actions/setup-julia@v1
        with:
          version: '1.9'
          
      # Install your project dependencies
      - name: Install Python dependencies
        run: |
          source $HOME/.cargo/env
          uv venv .venv
          source .venv/bin/activate
          uv pip install .
          
      # Test R helpers
      - name: Test R helpers
        run: |
          Rscript airflow/helpers_R/get_weather_summary_path.R || echo "R helper test skipped"
          
      # Verify installations
      - name: Verify all languages
        run: |
          python --version
          uv --version
          R --version
          julia --version
